!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?module.exports=t():e.Unlock=t()}(this,function(){function e(e){var t=this;e=function(e,t){if(void 0===e)throw new Error("You need to supply an options object");var o,n={};for(o in e)if(Object.prototype.hasOwnProperty.call(e,o)&&void 0===t[o])throw new Error("Unrecognized option "+o);for(o in t)if(Object.prototype.hasOwnProperty.call(t,o)){var r=t[o],u=e[o];if(void 0===u){if(r.required)throw new Error("Value "+o+" must be defined and of type "+r.type);n[o]=r.default}else{if(typeof u!==r.type)throw new Error("Value "+o+" must be of type "+r.type);n[o]=u}}return n}(e,{url:{required:!0,type:"string"},email:{required:!0,type:"string"},onMessage:{required:!0,type:"function"},button:{required:!1,type:"boolean",default:!0},buttonId:{required:!1,type:"string",default:"#unlock-button"},submitOnEnter:{required:!1,type:"boolean",default:!1},whatsThis:{required:!1,type:"boolean",default:!1},color:{required:!1,type:"string",default:"#2f81c6"},extra:{required:!1,type:"object",default:{}},onSend:{required:!1,type:"function",default:function(){}},onOpen:{required:!1,type:"function",default:function(){}},onClose:{required:!1,type:"function",default:function(){}}}),t.url=e.url,t.email=o(e.email),t.extra=e.extra,t.button=e.button,t.buttonId=o(e.buttonId),t.submitOnEnter=e.submitOnEnter,t.whatsThis=e.whatsThis,t.color=function(e){var t=e.match(/^#?([0-9a-f]{6})$/i);if(t)return("#"+t[1]).toLowerCase();if(t=e.match(/^#?([1-9a-f])([1-9a-f])([1-9a-f])$/i))return("#"+t[1]+t[1]+t[2]+t[2]+t[3]+t[3]).toLowerCase();var o="[0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5]",n=new RegExp("^rgb\\(("+o+"), ?("+o+"), ?("+o+")\\)$");if(t=e.match(n))return("#"+r(t[1])+r(t[2])+r(t[3])).toLowerCase();throw new Error("Unrecognized color "+e+". Must be either hex or rgb format")}(e.color),t.onMessage=e.onMessage,t.onSend=e.onSend,t.onOpen=e.onOpen,t.onClose=e.onClose,t.socket=new WebSocket(t.url),t.open=!1,t.shouldSend=!1,t._setupSocket(),t.button&&(t.onclick=t._submit.bind(t),t._buildButton(),t.submitOnEnter&&(document.querySelector(t.email).onkeyup=function(e){13===(e.which||e.keyCode)&&t.onclick()}))}function o(e){if(!document.querySelector(e))throw new Error("No element found with id "+e);return e}function c(e,t){e=e.slice(1);var o=30;t||(o*=-1);var n=parseInt(e,16);return"#"+r((n>>16)+o)+r((n>>8&255)+o)+r((255&n)+o)}function r(e){255<(e=parseInt(e))&&(e=255),e<0&&(e=0);var t=e.toString(16);return 1===t.length&&(t="0"+t),t}return e.prototype.unlock=function(){var e=this;e.onSend();var t={type:"unlock",email:e._getEmail()};!function(e){return 0===Object.keys(e).length}(e.extra)&&(t.extra=e.extra),e.socket.send(JSON.stringify(t))},e.prototype.isOpen=function(){return this.open},e.prototype.enableButton=function(){var e=this;if(e.button){var t=document.querySelector(e.buttonId).querySelector(".unlock-button");t.removeEventListener("click",e.onclick),t.addEventListener("click",e.onclick),t.classList.remove("unlock-disabled"),t.classList.add("unlock-enabled")}},e.prototype.disableButton=function(){var e=this;if(e.button){var t=document.querySelector(e.buttonId).querySelector(".unlock-button");t.removeEventListener("click",e.onclick),t.classList.remove("unlock-enabled"),t.classList.add("unlock-disabled")}},e.prototype._setupSocket=function(){var e=this;e.socket.onopen=function(){e.open=!0,e.shouldSend&&(e.unlock(),e.shouldSend=!1),e.onOpen()},e.socket.onclose=function(){e.socket=void 0,e.open=!1,e.onClose()},e.socket.onmessage=function(t){var o;try{o=JSON.parse(t.data)}catch(e){o=t.data}e.button&&e.enableButton(),e.onMessage(o)},e.socket.onerror=function(e){throw e}},e.prototype._getEmail=function(){return document.querySelector(this.email).value},e.prototype._submit=function(){var e=this;e.open?(e.disableButton(),e.unlock()):e.shouldSend=!0},e.prototype._buildButton=function(){var e=this,t=document.querySelector(e.buttonId);if(t.querySelector(".unlock-logo")){var o=t.cloneNode(!0);t.parentNode.replaceChild(o,t)}else{var n='<div class="unlock-button unlock-enabled"><img class="unlock-logo" src="https://www.unlock-auth.com/images/unlock-logo-text.svg"><span class="unlock-cover"></span><div class="unlock-spinner"><div class="unlock-dot unlock-dot-one"></div><div class="unlock-dot unlock-dot-two"></div><div class="unlock-dot unlock-dot-three"></div></div></div>';e.whatsThis&&(n+='<div class="unlock-link"><a href="https://www.unlock-auth.com" target="_blank">What\'s this?</a></div>'),t.innerHTML=n}e._addColor(),e.enableButton()},e.prototype._addColor=function(){var e=this,t=e.color,o=c(e.color,!0),n=c(e.color,!1),r=document.createElement("style");r.appendChild(document.createTextNode("")),document.head.appendChild(r);var u=r.sheet;u.insertRule(e.buttonId+" .unlock-button {background-color: "+t+"}",u.cssRules.length),u.insertRule(e.buttonId+" .unlock-button.unlock-enabled:hover {background-color: "+o+"}",u.cssRules.length),u.insertRule(e.buttonId+" .unlock-button.unlock-enabled:active {background-color: "+n+"}",u.cssRules.length),e.whatsThis&&u.insertRule(e.buttonId+" .unlock-link a {color: "+t+"}",u.cssRules.length)},e});