(function () {var e={};function m(o,t){if(!(o instanceof t))throw new TypeError("Cannot call a class as a function")}function h(o,t){for(var i=0;i<t.length;i++){var e=t[i];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(o,e.key,e)}}function n(o,t,i){return t&&h(o.prototype,t),i&&h(o,i),o}function o(o){new z(o)}function p(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var s=0;s<t.length;s++){var n=t[s];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function q(e,t,s){return t&&i(e.prototype,t),s&&i(e,s),e}var r=function(){function e(t,s){p(this,e),this.url=t,this.onMessage=s,this.open=!1,this.actions=[],this.socket=new WebSocket(this.url),this.socket.onopen=this.onOpen.bind(this),this.socket.onclose=this.onClose.bind(this),this.socket.onmessage=this._onMessage.bind(this)}return q(e,[{key:"onOpen",value:function(){for(this.open=!0;this.actions.length;){var e=this.actions.pop();this.send(e)}}},{key:"onClose",value:function(){this.socket=void 0,this.open=!1}},{key:"_onMessage",value:function(e){var t;try{t=JSON.parse(e.data)}catch(s){t=e.data}this.onMessage(t)}},{key:"send",value:function(e){this.open?this.socket.send(JSON.stringify(e)):this.actions.push(e)}}]),e}();function b(e){var t=document.querySelector(e);if(!t)throw new Error("No element found with id "+e);return t}function j(e){return document.querySelector(e).value}function s(e){for(;e.firstChild;)e.removeChild(e.firstChild)}function f(e,t,o){e.classList.add("ul-invisible"),setTimeout(function(){s(e),e.innerHTML=t,e.classList.remove("ul-invisible"),e.classList.add("ul-visible"),setTimeout(function(){e.classList.remove("ul-visible"),o()},200)},200)}function u(e){var t=document.createElement("style");t.appendChild(document.createTextNode("")),document.head.appendChild(t);var o=t.sheet;e.forEach(function(e){o.insertRule(e,o.cssRules.length)})}function c(e,t){e.addEventListener("click",t)}function k(e,t){e.removeEventListener("click",t)}function v(e,t){document.querySelector(e).onkeyup=function(e){13===(e.which||e.keyCode)&&t()}}function w(e){return(w="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function a(e,o,r){return{required:e,type:o,fallback:r}}function x(e,o){if(void 0===e)throw new Error("You need to supply an options object");var r,t={};for(r in e)if(Object.prototype.hasOwnProperty.call(e,r)&&void 0===o[r])throw new Error("Unrecognized option "+r);for(r in o)if(Object.prototype.hasOwnProperty.call(o,r)){var n=o[r],p=e[r];if(void 0===p){if(n.required)throw new Error("Value "+r+" must be defined and of type "+n.type);t[r]=n.fallback}else{if(w(p)!==n.type)throw new Error("Value "+r+" must be of type "+n.type);t[r]=p}}return t}function y(r){var e=r.match(/^#?([0-9a-f]{6})$/i);if(e)return("#"+e[1]).toLowerCase();if(e=r.match(/^#?([1-9a-f])([1-9a-f])([1-9a-f])$/i))return("#"+e[1]+e[1]+e[2]+e[2]+e[3]+e[3]).toLowerCase();var t="[0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5]",$=new RegExp("^rgb\\(("+t+"), ?("+t+"), ?("+t+")\\)$");if(e=r.match($))return("#"+d(e[1])+d(e[2])+d(e[3])).toLowerCase();throw new Error("Unrecognized color "+r+". Must be either hex or rgb format")}function l(r,e){r=r.slice(1);var t=30;e||(t*=-1);var $=parseInt(r,16);return"#"+d(($>>16)+t)+d(($>>8&255)+t)+d((255&$)+t)}function d(r){(r=parseInt(r))>255&&(r=255),r<0&&(r=0);var e=r.toString(16);return 1===e.length&&(e="0"+e),e}function t(t){return 0===Object.keys(t).length}e.init=o;var g="https://unlock-app.com/",z=function(){function o(t){m(this,o);var i=this,e={url:a(!0,"string"),email:a(!0,"string"),onMessage:a(!0,"function"),submitOnEnter:a(!1,"boolean",!1),whatsThis:a(!1,"boolean",!1),color:a(!1,"string","#2f81c6"),extra:a(!1,"object",{})};i.opts=x(t,e),b(i.opts.email),b("#unlock-button"),i.opts.color=y(i.opts.color),i.socket=new r(i.opts.url,function(o){i.enableButton(),i.opts.onMessage(o)}),i.unlock=i._unlock.bind(i),i.buildButton(),i.opts.submitOnEnter&&v(i.opts.email,i.unlock)}return n(o,[{key:"_unlock",value:function(){if(""!==this.email){this.disableButton();var o={type:"Unlock",email:this.email};t(this.opts.extra)||(o.extra=this.opts.extra),this.socket.send(o)}}},{key:"enableButton",value:function(){var o=b("#unlock-button").querySelector("#ul-button");k(o,this.unlock),c(o,this.unlock),o.classList.remove("ul-disabled"),o.classList.add("ul-enabled")}},{key:"disableButton",value:function(){var o=b("#unlock-button").querySelector("#ul-button");k(o,this.unlock),o.classList.remove("ul-enabled"),o.classList.add("ul-disabled")}},{key:"buildButton",value:function(){var o=b("#unlock-button");if(o.querySelector("#ul-button")){var t=o.cloneNode(!0);o.parentNode.replaceChild(t,o)}else{var i="<div id=\"ul-button\" class=\"ul-enabled\"><img id=\"ul-logo\" src=\""+g+"images/unlock-logo-text.svg\" alt=\"unlock\"><span id=\"ul-cover\"></span><div id=\"ul-spinner\"><div id=\"ul-dot-one\" class=\"ul-dot\"></div><div id=\"ul-dot-two\" class=\"ul-dot\"></div><div id=\"ul-dot-three\" class=\"ul-dot\"></div></div></div>";this.opts.whatsThis&&(i+="<div id=\"ul-link\">What's this?</div><div id=\"ul-modal\" class=\"ul-d-none\"><div id=\"ul-modal-overlay\"></div><div id=\"ul-modal-container\"><div id=\"ul-modal-logo-container\"><img id=\"ul-modal-logo\" src=\""+g+"images/unlock-icon.svg\"></div><div id=\"ul-modal-close\">&times;</div><div id=\"ul-modal-content\"></div></div></div>"),o.innerHTML=i}this.addColor(),this.setupModal(),this.enableButton()}},{key:"addColor",value:function(){var o=this.opts.color,t=l(o,!0),i=l(o,!1),e=["#unlock-button #ul-button {background-color: ".concat(o,"}"),"#unlock-button #ul-button.ul-enabled:hover {background-color: ".concat(t,"}"),"#unlock-button #ul-button.ul-enabled:active {background-color: ".concat(i,"}")];this.opts.whatsThis&&e.push("#unlock-button #ul-link {color: ".concat(o,"}")),u(e)}},{key:"setupModal",value:function(){if(this.opts.whatsThis){var o=b("#ul-link"),t=b("#ul-modal"),i=b("#ul-modal-overlay"),e=b("#ul-modal-content"),n=b("#ul-modal-close"),l=this.openModal.bind(null,t),a=this.closeModal.bind(null,t);c(o,l),c(i,a),c(n,a),c(e,function(o){return o.stopPropagation()}),this.makeModalContent()}}},{key:"openModal",value:function(o){o.classList.remove("ul-d-none"),window.setTimeout(function(){o.classList.add("ul-open")})}},{key:"closeModal",value:function(o){o.classList.remove("ul-open"),window.setTimeout(function(){o.classList.add("ul-d-none")},200)}},{key:"handleInput",value:function(o){var t=this;t.reader||(t.reader=new FileReader,t.reader.onload=function(o){return t.makePreview(o.target.result)}),t.reader.readAsDataURL(o.target.files[0])}},{key:"makeModalContent",value:function(){var o=this,t=b("#ul-modal-content");f(t,"<div id=\"ul-modal-title\">Sign up for Unlock</div><div id=\"ul-modal-description\">Unlock allows you to sign up and log in to web based applications without ever needing a password. You need to create an Unlock account once, and then you can use it on any participating site or app. Learn more at <a href=\"https://unlock-app.com\" target=\"_blank\">the Unlock website</a></div><input id=\"ul-modal-email\" type=\"email\" placeholder=\"Enter your email address\"><div id=\"ul-modal-picture\"></div><div id=\"ul-modal-picture-description\"><div>*Make sure you use a picture that clearly shows your face, and only contains you in it.</div><div>Your picture is never stored or shared with anyone. It is converted into a number and then encrypted. The number is only used when you log in to the Unlock website.</div></div><button id=\"ul-modal-signup\">Sign up</button>",function(){var t=b("#ul-modal-signup");c(t,o.signup.bind(o)),o.makePictureActions()})}},{key:"makePictureActions",value:function(){var o=this;this.image="";var t=b("#ul-modal-picture");f(t,"<div id=\"ul-modal-picture-buttons\"><button id=\"ul-modal-picture-take\" class=\"ul-button\">Take</button> or <button id=\"ul-modal-picture-upload\" class=\"ul-button\">upload</button><input id=\"ul-modal-picture-input\" type=\"file\" accept=\"image/*\"></div><div id=\"ul-modal-picture-text\">a picture of yourself*</div>",function(){var t=b("#ul-modal-picture-take"),i=b("#ul-modal-picture-upload"),e=b("#ul-modal-picture-input");c(t,o.makeCamera.bind(o)),c(i,function(){return e.click()}),e.addEventListener("change",o.handleInput.bind(o))})}},{key:"makeCamera",value:function(){var o=b("#ul-modal-content");f(o,"<div>Camera</div>")}},{key:"makePreview",value:function(o){var t=this;this.image=o;var i="<div id=\"ul-modal-preview\"><img id=\"ul-modal-preview-picture\" src=\""+o+"\"><div id=\"ul-modal-preview-close\">&times;</div></div>",e=b("#ul-modal-picture");f(e,i,function(){c(b("#ul-modal-preview-close"),t.makePictureActions.bind(t))})}},{key:"signup",value:function(){var o=j("#ul-modal-email");fetch(g+"api/signup",{method:"POST",headers:{"content-type":"text/plain"},body:JSON.stringify({email:o,image:this.image})})}},{key:"email",get:function(){return j(this.opts.email)}}]),o}();if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=e}else if(typeof define==="function"&&define.amd){define(function(){return e})}else{this["Unlock"]=e}})();