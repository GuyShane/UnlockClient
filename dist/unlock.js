(function () {var e={};function l(o){new x(o)}class m{constructor(s,t){this.url=s,this.onMessage=t,this.open=!1,this.actions=[],this.socket=new WebSocket(this.url),this.socket.onopen=this.onOpen.bind(this),this.socket.onclose=this.onClose.bind(this),this.socket.onmessage=this._onMessage.bind(this)}onOpen(){for(this.open=!0;this.actions.length;){const s=this.actions.pop();this.send(s)}}onClose(){this.socket=void 0,this.open=!1}_onMessage(s){let t;try{t=JSON.parse(s.data)}catch(e){t=s.data}this.onMessage(t)}send(s){this.open?this.socket.send(JSON.stringify(s)):this.actions.push(s)}}function b(e){const t=document.querySelector(e);if(!t)throw new Error("No element found with id "+e);return t}function i(e){return document.querySelector(e).value}function n(e){for(;e.firstChild;)e.removeChild(e.firstChild)}function f(e,t,o){e.classList.add("ul-invisible"),setTimeout(()=>{n(e),e.innerHTML=t,e.classList.remove("ul-invisible"),e.classList.add("ul-visible"),setTimeout(()=>{e.classList.remove("ul-visible"),o()},200)},200)}function p(e){const t=document.createElement("style");t.appendChild(document.createTextNode("")),document.head.appendChild(t);const o=t.sheet;e.forEach(e=>{o.insertRule(e,o.cssRules.length)})}function c(e,t){e.addEventListener("click",t)}function j(e,t){e.removeEventListener("click",t)}function q(e,t){document.querySelector(e).onkeyup=e=>{13===(e.which||e.keyCode)&&t()}}async function r(){const t=window.navigator.mediaDevices;return!(!t||!t.enumerateDevices)&&(await t.enumerateDevices()).some(t=>"videoinput"===t.kind)}async function s(t){const e=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user",width:{max:1280}},audio:!1});return t.srcObject=e,t.play(),e}function u(t,e){const a=e.getContext("2d");return e.width=t.videoWidth,e.height=t.videoHeight,a.translate(e.width,0),a.scale(-1,1),a.drawImage(t,0,0,e.width,e.height),e.toDataURL("image/png")}function g(t){t.getTracks()[0].stop()}function a(e,r,o){return{required:e,type:r,fallback:o}}function v(e,r){if(void 0===e)throw new Error("You need to supply an options object");var o,t={};for(o in e)if(Object.prototype.hasOwnProperty.call(e,o)&&void 0===r[o])throw new Error("Unrecognized option "+o);for(o in r)if(Object.prototype.hasOwnProperty.call(r,o)){var n=r[o],p=e[o];if(void 0===p){if(n.required)throw new Error("Value "+o+" must be defined and of type "+n.type);t[o]=n.fallback}else{if(typeof p!==n.type)throw new Error("Value "+o+" must be of type "+n.type);t[o]=p}}return t}function w(r){var e=r.match(/^#?([0-9a-f]{6})$/i);if(e)return("#"+e[1]).toLowerCase();if(e=r.match(/^#?([1-9a-f])([1-9a-f])([1-9a-f])$/i))return("#"+e[1]+e[1]+e[2]+e[2]+e[3]+e[3]).toLowerCase();var t="[0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5]",$=new RegExp("^rgb\\(("+t+"), ?("+t+"), ?("+t+")\\)$");if(e=r.match($))return("#"+d(e[1])+d(e[2])+d(e[3])).toLowerCase();throw new Error("Unrecognized color "+r+". Must be either hex or rgb format")}function k(r,e){r=r.slice(1);var t=30;e||(t*=-1);var $=parseInt(r,16);return"#"+d(($>>16)+t)+d(($>>8&255)+t)+d((255&$)+t)}function d(r){(r=parseInt(r))>255&&(r=255),r<0&&(r=0);var e=r.toString(16);return 1===e.length&&(e="0"+e),e}function t(t){return 0===Object.keys(t).length}e.init=l;const h="https://unlock-app.com/";class x{constructor(o){const t=this,i={url:a(!0,"string"),email:a(!0,"string"),onMessage:a(!0,"function"),submitOnEnter:a(!1,"boolean",!1),whatsThis:a(!1,"boolean",!1),color:a(!1,"string","#2f81c6"),extra:a(!1,"object",{})};t.opts=v(o,i),b(t.opts.email),b("#unlock-button"),t.opts.color=w(t.opts.color),t.socket=new m(t.opts.url,o=>{t.enableButton(),t.opts.onMessage(o)}),t.unlock=t._unlock.bind(t),t.buildButton(),t.opts.submitOnEnter&&q(t.opts.email,t.unlock)}get email(){return i(this.opts.email)}_unlock(){if(""===this.email)return;this.disableButton();const o={type:"Unlock",email:this.email};t(this.opts.extra)||(o.extra=this.opts.extra),this.socket.send(o)}enableButton(){const o=b("#unlock-button").querySelector("#ul-button");j(o,this.unlock),c(o,this.unlock),o.classList.remove("ul-disabled"),o.classList.add("ul-enabled")}disableButton(){const o=b("#unlock-button").querySelector("#ul-button");j(o,this.unlock),o.classList.remove("ul-enabled"),o.classList.add("ul-disabled")}buildButton(){const o=b("#unlock-button");if(o.querySelector("#ul-button")){const t=o.cloneNode(!0);o.parentNode.replaceChild(t,o)}else{let t="<div id=\"ul-button\" class=\"ul-enabled\"><img id=\"ul-logo\" src=\""+h+"images/unlock-logo-text.svg\" alt=\"unlock\"><span id=\"ul-cover\"></span><div id=\"ul-spinner\"><div id=\"ul-dot-one\" class=\"ul-dot\"></div><div id=\"ul-dot-two\" class=\"ul-dot\"></div><div id=\"ul-dot-three\" class=\"ul-dot\"></div></div></div>";this.opts.whatsThis&&(t+="<div id=\"ul-link\">What's this?</div><div id=\"ul-modal\" class=\"ul-d-none\"><div id=\"ul-modal-overlay\"></div><div id=\"ul-modal-container\"><div id=\"ul-modal-logo-container\"><img id=\"ul-modal-logo\" src=\""+h+"images/unlock-icon.svg\"></div><div id=\"ul-modal-close\">&times;</div><div id=\"ul-modal-content\"></div></div></div>"),o.innerHTML=t}this.addColor(),this.setupModal(),this.enableButton()}addColor(){const o=this.opts.color,t=[`#unlock-button #ul-button {background-color: ${o}}`,`#unlock-button #ul-button.ul-enabled:hover {background-color: ${k(o,!0)}}`,`#unlock-button #ul-button.ul-enabled:active {background-color: ${k(o,!1)}}`];this.opts.whatsThis&&t.push(`#unlock-button #ul-link {color: ${o}}`),p(t)}setupModal(){if(!this.opts.whatsThis)return;const o=b("#ul-link"),t=b("#ul-modal"),i=b("#ul-modal-overlay"),e=b("#ul-modal-content"),m=b("#ul-modal-close"),a=this.openModal.bind(this,t),l=this.closeModal.bind(this,t);c(o,a),c(i,l),c(m,l),c(e,o=>o.stopPropagation()),this.makeModalContent()}openModal(o){o.classList.remove("ul-d-none"),window.setTimeout(()=>{o.classList.add("ul-open")})}closeModal(o){this.stream&&g(this.stream),o.classList.remove("ul-open"),window.setTimeout(()=>{o.classList.add("ul-d-none")},200)}handleInput(o){const t=this;t.reader||(t.reader=new FileReader,t.reader.onload=o=>t.makePreview(o.target.result)),t.reader.readAsDataURL(o.target.files[0])}makeModalContent(){const o=b("#ul-modal-content");f(o,"<div id=\"ul-modal-title\">Sign up for Unlock</div><div id=\"ul-modal-description\">Unlock allows you to sign up and log in to web based applications without ever needing a password. You need to create an Unlock account once, and then you can use it on any participating site or app. Learn more at <a href=\"https://unlock-app.com\" target=\"_blank\">the Unlock website</a></div><input id=\"ul-modal-email\" type=\"email\" placeholder=\"Enter your email address\"><div id=\"ul-modal-picture\"></div><div id=\"ul-modal-picture-description\"><div>*Make sure you use a picture that clearly shows your face, and only contains you in it.</div><div>Your picture is never stored or shared with anyone. It is converted into a number and then encrypted. The number is only used when you log in to the Unlock website.</div></div><button id=\"ul-modal-signup\">Sign up</button>",()=>{const o=b("#ul-modal-signup");c(o,this.signup.bind(this)),this.makePictureActions()})}makePictureActions(){this.image="";const o=b("#ul-modal-picture");f(o,"<div id=\"ul-modal-picture-buttons\"><button id=\"ul-modal-picture-take\" class=\"ul-button\">Take</button> or <button id=\"ul-modal-picture-upload\" class=\"ul-button\">upload</button><input id=\"ul-modal-picture-input\" type=\"file\" accept=\"image/*\"></div><div id=\"ul-modal-picture-text\">a picture of yourself*</div>",()=>{const o=b("#ul-modal-picture-take"),t=b("#ul-modal-picture-upload"),i=b("#ul-modal-picture-input");c(o,this.makeCamera.bind(this)),c(t,()=>i.click()),i.addEventListener("change",this.handleInput.bind(this))})}async makeCamera(){if(!(await r()))return void alert("No camera detected on this device");const o=b("#ul-modal-picture");f(o,"<div id=\"ul-modal-camera\"><video id=\"ul-modal-camera-video\"></video><canvas id=\"ul-modal-camera-canvas\"></canvas><button id=\"ul-modal-camera-take\"><svg width=\"25\" height=\"18\" viewBox=\"0 0 72 53\" fill=\"none\" stroke=\"white\" stroke-width=\"6\" xmlns=\"http://www.w3.org/2000/svg\"><circle cx=\"36\" cy=\"31\" r=\"11.5\"/><path d=\"M2.5 15.5V47.5C2.5 49.1569 3.84315 50.5 5.5 50.5H66.5C68.1569 50.5 69.5 49.1569 69.5 47.5V15.5C69.5 13.8431 68.1569 12.5 66.5 12.5H52.5C50.8431 12.5 49.5 11.1569 49.5 9.5V5.5C49.5 3.84315 48.1569 2.5 46.5 2.5H25.5C23.8431 2.5 22.5 3.84315 22.5 5.5V9.5C22.5 11.1569 21.1569 12.5 19.5 12.5H5.5C3.84315 12.5 2.5 13.8431 2.5 15.5Z\"/></svg></button><div id=\"ul-modal-camera-close\">&times</div></div>",async()=>{const o=b("#ul-modal-camera-video"),t=b("#ul-modal-camera-canvas"),i=b("#ul-modal-camera-close"),e=b("#ul-modal-camera-take");this.stream=await s(o),c(i,()=>{g(this.stream),this.makePictureActions()}),c(e,()=>{const i=u(o,t);g(this.stream),this.makePreview(i)})})}makePreview(o){this.image=o;const t="<div id=\"ul-modal-preview\"><img id=\"ul-modal-preview-picture\" src=\""+o+"\"><div id=\"ul-modal-preview-close\">&times;</div></div>",i=b("#ul-modal-picture");f(i,t,()=>{c(b("#ul-modal-preview-close"),this.makePictureActions.bind(this))})}signup(){const o=i("#ul-modal-email");fetch(h+"api/signup",{method:"POST",headers:{"content-type":"text/plain"},body:JSON.stringify({email:o,image:this.image})})}}if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=e}else if(typeof define==="function"&&define.amd){define(function(){return e})}else{this["Unlock"]=e}})();